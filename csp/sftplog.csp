<html>
<head>
<title>iris-sftp-logs</title>
</head>

<body>
<h1>iris-sftp-logs</h1>
<script language="Cache" runat="Server">
Set tDirectory = ""
Set tFilename = ""
Set tImport = ""
If ($Data(%request.Data("iDirectory",1))) {
	Set tDirectory = %request.Data("iDirectory",1)
}
If ($Data(%request.Data("iFilename",1))) {
	Set tFilename = %request.Data("iFilename",1)
}
If ($Data(%request.Data("iImport",1))) {
	Set tImport = %request.Data("iImport",1)
}
If tImport Set tSC = ##class(SFTPLog).ReadLog(tDirectory,tFilename)
</script>
<form>
<table><tr><td>
<label for="iDirectory">SFTP Log File Directory:</label>
</td><td>
<input type="text" id="iDirectory" name="iDirectory" size="150" value="#($Get(tDirectory))#"><br>
</td></tr><tr><td>
<label for="iFilename">SFTP Log Filename:</label>
</td><td>
<input type="text" id="iFilename" name="iFilename" size="150" value="#($Get(tFilename))#"><br>
</td></tr><tr><td>
<input type="checkbox" id="iImport" name="iImport" value="1">
<label for="iImport">Import this log file</label><br>
</td></tr></table>
<input type="submit" value="Submit">
</form>

<table border=1><tr>
<th>ContainerID</th>
<th>Open Timestamp</th>
<th>User IP</th>
<th>Username</th>
</tr>
<script language="Cache" runat="Server">
Set tSC = ##class(Session).OutputTableData()
</script>
</table>
<script language="Cache" runat="Server">
Write "<textarea id='debug' name='debug' rows='25' cols='155'>",!
Set tRow = ""
Set tFile = tDirectory_tFilename
Set tSC = ##class(%File).DirectoryExists(tDirectory)
//If '$$$ISOK(tSC) Quit tSC
Set tSC = ##class(%File).Exists(tFile)
//If '$$$ISOK(tSC) Quit tSC
Set tF = ##class(%File).%New(tFile)
//If '$IsObject(tF) Quit tSC
Set tSC = tF.Open("R")
//If '$$$ISOK(tSC) Quit tSC
For {
	If '$$$ISOK(tSC) Quit
	Set tLen = 32000
	Set tLog = tF.Read(.tLen,.tSC)
	If '$$$ISOK(tSC) Quit
	If (tLen < 2) Quit
	Write tLog,!
	//Set tSC = ..OneLine(tLog,.tSessionID,.tTransferID)
	If ($Increment(tRow) > 24) { Quit }
}
Do tF.Close()
Set tF = ""
Write "</textarea>","<br>",!
//Write "<a href='/csp/sys/exp/UtilExpGlobalView.csp?$ID2=TESTunit&$NAMESPACE=",$Namespace,"'>View Debug Global"
</script>
</body>
</html>
